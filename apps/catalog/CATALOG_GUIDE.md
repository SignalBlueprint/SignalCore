# Catalog - Product Management with AI

Complete product catalog system with AI-powered image analysis, automatic product shot generation, vector search, inventory tracking, and public storefront capabilities.

## Features

- **üì∏ Image Upload**: Take photos on your phone and upload via API
- **üëÅÔ∏è AI Vision Analysis**: Automatic product metadata extraction using OpenAI Vision
- **üé® Image Generation**: Generate clean product shots using DALL-E 3
- **üîç Vector Search**: Semantic product search using OpenAI embeddings
- **üì¶ Inventory Management**: Track stock levels and manage inventory
- **üõí Public Storefront**: Customer-facing API for online stores
- **üìñ Lookbooks**: Organize products into collections

## Quick Start

### 1. Install Dependencies

```bash
cd apps/catalog
pnpm install
```

### 2. Environment Setup

Add to your root `.env` file:

```env
# Required
OPENAI_API_KEY=sk-xxx

# Optional - for Supabase storage
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=xxx

# Optional - image generation service
IMAGE_GENERATION_SERVICE=dalle  # or 'custom'
```

### 3. Database Setup (Supabase)

If using Supabase, run the migration:

```bash
# In your Supabase SQL Editor, run:
docs/supabase-migrations/001_create_tables.sql
docs/supabase-migrations/002_catalog_tables.sql
```

This creates:
- `products` table with pgvector support
- `lookbooks` table
- `store_settings` table
- Vector search functions

### 4. Start the Server

```bash
pnpm dev
```

Server will run on `http://localhost:4023`

## API Endpoints

### Products

#### Upload & Analyze Product Image

```bash
POST /api/products/upload

# With curl (multipart form data)
curl -X POST http://localhost:4023/api/products/upload \
  -F "image=@product-photo.jpg" \
  -F "orgId=default-org" \
  -F "autoAnalyze=true" \
  -F "generateClean=true"

# Response:
{
  "id": "uuid",
  "orgId": "default-org",
  "name": "Vintage Leather Jacket",  // Detected by AI
  "description": "A classic brown leather jacket...",  // Generated by AI
  "category": "Clothing",
  "price": 150,  // Suggested by AI
  "tags": ["vintage", "leather", "outerwear"],
  "status": "draft",
  "images": [
    {
      "id": "uuid",
      "url": "https://...",
      "type": "original"
    },
    {
      "id": "uuid",
      "url": "https://...",
      "type": "generated"  // Clean product shot
    }
  ],
  "visionAnalysis": {
    "detectedName": "Vintage Leather Jacket",
    "description": "...",
    "colors": ["brown", "tan"],
    "materials": ["leather"],
    "confidence": 0.95
  },
  "embedding": [0.123, 0.456, ...],  // 1536-dim vector
  "createdAt": "2025-01-15T10:30:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

#### Get All Products

```bash
GET /api/products?orgId=default-org&status=active&category=Clothing

# Response:
[
  { /* product 1 */ },
  { /* product 2 */ }
]
```

#### Get Product by ID

```bash
GET /api/products/:id

# Response:
{
  "id": "uuid",
  "name": "Product Name",
  ...
}
```

#### Create Product Manually

```bash
POST /api/products
Content-Type: application/json

{
  "orgId": "default-org",
  "name": "Custom Product",
  "description": "Manual product entry",
  "price": 99.99,
  "category": "Electronics",
  "status": "active",
  "inventory": {
    "stockLevel": 50,
    "sku": "PROD-001"
  }
}
```

#### Update Product

```bash
PUT /api/products/:id
Content-Type: application/json

{
  "name": "Updated Name",
  "price": 129.99,
  "status": "active"
}
```

#### Delete Product

```bash
DELETE /api/products/:id

# Response:
{
  "success": true
}
```

### AI Features

#### Analyze Existing Product

```bash
POST /api/products/:id/analyze

# Re-analyzes the product's primary image with OpenAI Vision
# Updates metadata, category, tags, and embedding
```

#### Generate Clean Product Shot

```bash
POST /api/products/:id/generate-image

# Generates a professional product shot using DALL-E 3
# Adds it to the product's images array
```

#### Batch Upload Multiple Products

```bash
POST /api/products/upload/batch

# Upload up to 20 images at once (multipart form data)
curl -X POST http://localhost:4023/api/products/upload/batch \
  -F "images=@product1.jpg" \
  -F "images=@product2.jpg" \
  -F "images=@product3.jpg" \
  -F "orgId=default-org" \
  -F "autoAnalyze=true" \
  -F "generateClean=false"

# Response:
{
  "success": true,
  "created": 3,
  "failed": 0,
  "products": [
    { /* product 1 */ },
    { /* product 2 */ },
    { /* product 3 */ }
  ],
  "errors": []
}
```

#### Export Products to CSV

```bash
GET /api/products/export/csv?orgId=default-org

# Downloads CSV file with all products
# Includes: id, name, description, category, price, status, inventory, etc.
```

#### Import Products from CSV

```bash
POST /api/products/import/csv

# Upload CSV file with product data (multipart form data)
curl -X POST http://localhost:4023/api/products/import/csv \
  -F "file=@products.csv" \
  -F "orgId=default-org"

# CSV Format:
# Headers: id, name, description, category, price, currency, status, tags,
#          sku, stockLevel, lowStockThreshold, location, createdAt, updatedAt
# Tags should be semicolon-separated (e.g., "vintage;leather;jacket")

# Response:
{
  "success": true,
  "imported": 25,
  "failed": 2,
  "products": [ /* imported products */ ],
  "errors": [
    { "line": 12, "error": "Invalid price format" },
    { "line": 23, "error": "Missing required field: name" }
  ]
}
```

### Search

#### Semantic Vector Search

```bash
POST /api/products/search
Content-Type: application/json

{
  "query": "brown leather jacket vintage",
  "orgId": "default-org",
  "limit": 10
}

# Response:
{
  "query": "brown leather jacket vintage",
  "results": [
    {
      "id": "uuid",
      "name": "Vintage Leather Jacket",
      "_similarity": 0.89,  // Cosine similarity score
      ...
    }
  ]
}
```

### Inventory

#### Update Inventory

```bash
PUT /api/products/:id/inventory
Content-Type: application/json

{
  "stockLevel": 25,
  "lowStockThreshold": 5,
  "sku": "JACKET-001",
  "location": "Warehouse A"
}

# Automatically updates product status to "out_of_stock" if stockLevel <= 0
```

### Lookbooks

#### Get Lookbooks

```bash
GET /api/lookbooks?orgId=default-org
```

#### Create Lookbook

```bash
POST /api/lookbooks
Content-Type: application/json

{
  "orgId": "default-org",
  "title": "Summer Collection 2025",
  "description": "Latest summer arrivals",
  "products": ["product-id-1", "product-id-2"],
  "isPublic": true
}
```

### Store Settings

#### Get Store Settings

```bash
GET /api/store/settings?orgId=default-org
```

#### Update Store Settings

```bash
PUT /api/store/settings
Content-Type: application/json

{
  "orgId": "default-org",
  "storeName": "My Awesome Store",
  "isPublic": true,
  "currency": "USD",
  "branding": {
    "primaryColor": "#FF5733"
  }
}
```

### Public Storefront API

#### Get Public Products

```bash
GET /api/store/:orgId/products

# Only returns active products if store is public
# Perfect for customer-facing storefronts
```

#### Get Public Product

```bash
GET /api/store/:orgId/products/:productId
```

## Workflow Examples

### Mobile Upload Workflow

1. **Customer takes photo on phone**
2. **Upload to catalog API**:
   ```bash
   POST /api/products/upload
   - image: binary
   - autoAnalyze: true
   - generateClean: true
   ```
3. **AI automatically**:
   - Extracts product name, description, category
   - Suggests price based on analysis
   - Generates tags and metadata
   - Creates vector embedding for search
   - Generates clean product shot
4. **Review and publish**:
   ```bash
   PUT /api/products/:id
   {
     "status": "active",
     "price": 149.99  // Adjust if needed
   }
   ```

### Inventory Management Workflow

1. **Add product** (via upload or manual)
2. **Set initial inventory**:
   ```bash
   PUT /api/products/:id/inventory
   {
     "stockLevel": 100,
     "lowStockThreshold": 10,
     "sku": "PROD-001"
   }
   ```
3. **Auto-updates**: Product status changes to `out_of_stock` when inventory hits 0

### Public Store Workflow

1. **Configure store**:
   ```bash
   PUT /api/store/settings
   {
     "isPublic": true,
     "storeName": "My Store"
   }
   ```
2. **Publish products**:
   ```bash
   PUT /api/products/:id
   {
     "status": "active"
   }
   ```
3. **Customers access**:
   ```
   GET /api/store/default-org/products
   ```

## Architecture

### Data Flow

```
Mobile Phone Photo
    ‚Üì
Upload API
    ‚Üì
Storage (Supabase/Local)
    ‚Üì
OpenAI Vision Analysis ‚Üí Metadata Extraction
    ‚Üì
OpenAI Embeddings ‚Üí Vector for Search
    ‚Üì
DALL-E 3 ‚Üí Clean Product Shot
    ‚Üì
Database (Supabase/Local JSON)
```

### Tech Stack

- **Server**: Express.js
- **File Upload**: Multer
- **Storage**: Supabase Storage (or local filesystem)
- **Database**: Supabase (PostgreSQL + pgvector) or Local JSON
- **AI Vision**: OpenAI GPT-4o with Vision
- **Image Generation**: DALL-E 3 (or custom service)
- **Vector Embeddings**: OpenAI text-embedding-3-small (1536 dimensions)
- **Vector Search**: Cosine similarity (in-memory or pgvector)

## Configuration

### Image Generation Service

Set `IMAGE_GENERATION_SERVICE` in `.env`:

- `dalle` - Use DALL-E 3 (default)
- `custom` - Use custom service (implement in `packages/ai/src/image-generation.ts`)

### Storage Mode

- **Supabase**: Set `SUPABASE_URL` and `SUPABASE_ANON_KEY`
- **Local**: Set `STORAGE_MODE=local` or don't configure Supabase

## Advanced Features

### Custom Image Generation

To integrate your preferred image generation service (e.g., "nano banana"):

1. Edit `packages/ai/src/image-generation.ts`
2. Implement `CustomImageService` class
3. Set `IMAGE_GENERATION_SERVICE=custom` in `.env`

```typescript
export class CustomImageService implements ImageGenerationService {
  async generate(options: GenerateImageOptions): Promise<GeneratedImage> {
    // Your custom implementation
    const response = await fetch('https://your-service.com/generate', {
      // ... your API call
    });

    return {
      url: response.imageUrl,
      revisedPrompt: response.prompt
    };
  }
}
```

### pgvector Search (Production)

For production with Supabase, use the built-in vector search function:

```sql
SELECT * FROM search_products_by_embedding(
  query_embedding := '[0.123, 0.456, ...]'::vector,
  match_threshold := 0.7,
  match_count := 10,
  filter_org_id := 'default-org'
);
```

## Troubleshooting

### "OpenAI API key not set"

Add `OPENAI_API_KEY` to root `.env` file.

### "Table 'products' not found"

Run the Supabase migration or use local storage mode.

### "Failed to upload file"

Check Supabase storage bucket `product-images` exists, or use local mode.

### Image generation fails

Check your OpenAI API key has DALL-E 3 access, or implement custom service.

## Next Steps

- [ ] Add mobile app for easy photo uploads
- [x] Implement batch upload
- [x] Add CSV import/export
- [x] Build frontend catalog UI
- [ ] Add payment integration
- [ ] Implement order management
- [ ] Add product variants (size, color options)
- [ ] Implement barcode scanning for inventory
- [ ] Add analytics and reporting dashboard

## Support

For issues or questions, see the main [README](../../README.md) or check the [SUITE_MAP](../../docs/SUITE_MAP.md).
